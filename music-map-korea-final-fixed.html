<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Music Map Final Fixed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Mapbox ìŠ¤íƒ€ì¼ ë° ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- ìŠ¤íƒ€ì¼ ì„¤ì • -->
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      position: fixed;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    .nav-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      z-index: 9999;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 16px;
    }

    .info-container {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
      margin-right: 16px;
    }

    .location-display {
      color: #fff;
      font-family: 'pretendard', sans-serif;
      font-size: 24px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 400px;
      text-align: left;
    }

    .friend-icon {
      width: 32px;
      height: 32px;
      cursor: pointer;
      transition: opacity 0.2s ease;
      flex-shrink: 0;
    }

    .friend-icon:hover {
      opacity: 0.8;
    }

    .zoom-display {
      color: rgba(255, 255, 255, 0.8);
      font-family: 'pretendard', sans-serif;
      font-size: 14px;
      font-weight: 500;
      text-align: left;
    }

    .nav-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .location-button {
      position: fixed;
      left: 16px;
      bottom: 16px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: all 0.2s ease;
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border: none;
      padding: 0;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      z-index: 9999;
    }

    .location-button:hover {
      background: rgba(0, 0, 0, 0.75);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .location-button svg {
      width: 24px;
      height: 24px;
    }

    .location-button.active {
      background: #3B82F6;
    }

    .location-button.active:hover {
      background: #2563EB;
    }

    /* ëª¨ë°”ì¼ ë””ë°”ì´ìŠ¤ë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
    @media screen and (max-width: 768px) {
      .nav-bar {
        padding: 12px;
      }

      .info-container {
        margin-right: 12px;
        gap: 2px;
      }

      .location-display {
        font-size: 18px;
        max-width: 240px;
      }

      .friend-icon {
        width: 28px;
        height: 28px;
      }

      .location-button {
        left: 12px;
        bottom: max(env(safe-area-inset-bottom, 16px), 16px);
      }

      .nav-actions {
        gap: 8px;
      }

      .zoom-display {
        font-size: 12px;
      }
    }

    .character-img {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
    }

    .mapboxgl-popup-content {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        padding: 4px 8px 4px 8px;
        font-family: 'Noto Sans KR', sans-serif;
        font-size: 14px;
        color: #333;
        max-width: 160px;
    }

    .popup-content {
        display: flex;
        flex-direction: column;
        align-items: left;
    }

    .song-info {
        font-size: 14px;
        font-weight: 600;
        text-align: left;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .artist {
        font-size: 11px;
        font-weight: 400;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: rgba(0, 0, 0, 0.6);
    }

    .friends-page {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      z-index: 10000;
      display: none;
    }

    .friends-nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 16px;
      z-index: 10001;
    }

    .back-button {
      width: 32px;
      height: 32px;
      cursor: pointer;
      transition: opacity 0.2s ease;
      background: none;
      border: none;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .back-button:hover {
      opacity: 0.8;
    }

    @media screen and (max-width: 768px) {
      .friends-nav {
        height: 56px;
      }

      .back-button {
        width: 28px;
        height: 28px;
      }
    }
  </style>
</head>
<body>
  <!-- ì§€ë„ê°€ í‘œì‹œë  ì˜ì—­ -->
  <div id="map"></div>
  
  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
  <div class="nav-bar">
    <div class="info-container">
      <div class="location-display" id="locationDisplay"></div>
      <div class="zoom-display" id="zoomLevel">Zoom: -</div>
    </div>
    <div class="nav-actions">
      <a href="friends.html" class="friend-icon" id="friendButton">
        <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="white"/>
        </svg>
      </a>
    </div>
  </div>

  <!-- í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ -->
  <button class="location-button" id="currentLocation" title="í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 8C9.79 8 8 9.79 8 12C8 14.21 9.79 16 12 16C14.21 16 16 14.21 16 12C16 9.79 14.21 8 12 8ZM20.94 11C20.48 6.83 17.17 3.52 13 3.06V2C13 1.45 12.55 1 12 1C11.45 1 11 1.45 11 2V3.06C6.83 3.52 3.52 6.83 3.06 11H2C1.45 11 1 11.45 1 12C1 12.55 1.45 13 2 13H3.06C3.52 17.17 6.83 20.48 11 20.94V22C11 22.55 11.45 23 12 23C12.55 23 13 22.55 13 22V20.94C17.17 20.48 20.48 17.17 20.94 13H22C22.55 13 23 12.55 23 12C23 11.45 22.55 11 22 11H20.94ZM12 19C8.13 19 5 15.87 5 12C5 8.13 8.13 5 12 5C15.87 5 19 8.13 19 12C19 15.87 15.87 19 12 19Z" fill="white"/>
    </svg>
  </button>

  <!-- ì¹œêµ¬ í˜ì´ì§€ -->
  <div class="friends-page" id="friendsPage">
    <div class="friends-nav">
      <button class="back-button" id="backButton" title="ë’¤ë¡œê°€ê¸°">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 11H7.83L13.42 5.41L12 4L4 12L12 20L13.41 18.59L7.83 13H20V11Z" fill="white"/>
        </svg>
      </button>
    </div>
    <div style="padding: 80px 16px 16px">
      <h1>Friends Page</h1>
      <!-- ì¹œêµ¬ í˜ì´ì§€ ì»¨í…ì¸  -->
    </div>
  </div>

  <script>
    // Mapbox í† í°
    mapboxgl.accessToken = 'pk.eyJ1IjoibWluaHllb25na2ltIiwiYSI6ImNtYWRsNzA5ZTBld3Iya29uNG80MnFhZnMifQ.JwmMpGd-0shCxK5Q0JqgAQ';
    
    // í´ëŸ¬ìŠ¤í„° ìƒíƒœ ê´€ë¦¬
    let clusters = new Map();
    let isClusterMode = false;

    // ì¤Œ ë ˆë²¨ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateZoomDisplay() {
      requestAnimationFrame(() => {
        const zoomDisplay = document.getElementById('zoomLevel');
        const currentZoom = map.getZoom().toFixed(2);
        zoomDisplay.textContent = `Zoom: ${currentZoom}`;
        zoomDisplay.style.display = 'block';
        zoomDisplay.style.visibility = 'visible';
        zoomDisplay.style.opacity = '1';
      });
    }

    // ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateLocationDisplay() {
      const center = map.getCenter();
      const locationDisplay = document.getElementById('locationDisplay');
      const currentZoom = map.getZoom();
      
      // ì¤Œ ë ˆë²¨ 3 ì´í•˜ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
      if (currentZoom <= 3) {
        locationDisplay.style.display = 'none';
        locationDisplay.style.marginBottom = '0';
        return;
      }

      try {
        const response = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${center.lng},${center.lat}.json?access_token=${mapboxgl.accessToken}&language=ko`);
        const data = await response.json();
        
        if (data.features && data.features.length > 0) {
          // contextì—ì„œ place, district, region, country ì •ë³´ ì°¾ê¸°
          const context = data.features[0].context || [];
          const place = context.find(item => item.id.startsWith('place'))?.text;
          const district = context.find(item => item.id.startsWith('district'))?.text;
          const region = context.find(item => item.id.startsWith('region'))?.text;
          const country = context.find(item => item.id.startsWith('country'))?.text;
          
          // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ì£¼ì†Œ í‘œì‹œ
          let addressParts = [];
          
          if (currentZoom <= 7) {
            // ì¤Œ ë ˆë²¨ 7 ì´í•˜: êµ­ê°€ë§Œ í‘œì‹œ
            addressParts = country ? [country] : [];
          } else if (currentZoom > 7 && currentZoom < 10) {
            // ì¤Œ ë ˆë²¨ 7 ì´ˆê³¼ 10 ë¯¸ë§Œ: êµ­ê°€, ì‹œ/ë„ê¹Œì§€ í‘œì‹œ
            addressParts = [country, region].filter(Boolean);
          } else {
            // ì¤Œ ë ˆë²¨ 10 ì´ìƒ: ëª¨ë“  ì •ë³´ í‘œì‹œ
            addressParts = [country, region, district, place].filter(Boolean);
          }
          
          if (addressParts.length > 0) {
            const address = addressParts.join(' ');
            locationDisplay.textContent = address;
            locationDisplay.style.display = 'block';
            locationDisplay.style.marginBottom = '4px';
          } else {
            locationDisplay.style.display = 'none';
            locationDisplay.style.marginBottom = '0';
          }
        } else {
          locationDisplay.style.display = 'none';
          locationDisplay.style.marginBottom = '0';
        }
      } catch (error) {
        console.error('Error fetching location:', error);
        locationDisplay.style.display = 'none';
        locationDisplay.style.marginBottom = '0';
      }
    }

    // ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ë””ë°”ìš´ìŠ¤ ì ìš©
    const debouncedUpdateLocation = debounce(updateLocationDisplay, 500);

    // Mapbox ìŠ¤íƒ€ì¼, ì„¼í„° ì¢Œí‘œ, ì¤Œ ì •ë„
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/minhyeongkim/cmb0bsdjd00mq01rf97v47t59',
      center: [127.0276, 37.4979],
      zoom: 0,
      maxZoom: 16,
      minZoom: 0,
      pitch: 0,
      antialias: true,
      scrollZoom: {
        smooth: true,
        speed: 0.3,
        smoothTime: 100
      }
    });

    // ëª¨ë°”ì¼ í„°ì¹˜ ì„¤ì • ìµœì í™”
    if ('ontouchstart' in window) {
      map.dragRotate.disable(); // ëª¨ë°”ì¼ì—ì„œ íšŒì „ ë¹„í™œì„±í™”
      map.touchZoomRotate.disableRotation(); // ëª¨ë°”ì¼ì—ì„œ íšŒì „ ë¹„í™œì„±í™”
      
      // í„°ì¹˜ ì¤Œ ì´ë²¤íŠ¸ ì»¤ìŠ¤í„°ë§ˆì´ì§•
      let lastTouchDistance = null;
      let currentZoom = null;
      let zoomVelocity = 0;
      const ZOOM_SPEED = 0.01; // ì¤Œ ì†ë„ ì¡°ì ˆ

      map.on('touchstart', (e) => {
        if (e.points.length === 2) {
          lastTouchDistance = Math.hypot(
            e.points[0].x - e.points[1].x,
            e.points[0].y - e.points[1].y
          );
          currentZoom = map.getZoom();
          zoomVelocity = 0;
        }
      });

      map.on('touchmove', (e) => {
        if (e.points.length === 2 && lastTouchDistance !== null) {
          const newTouchDistance = Math.hypot(
            e.points[0].x - e.points[1].x,
            e.points[0].y - e.points[1].y
          );
          
          // ê±°ë¦¬ ë³€í™”ìœ¨ ê³„ì‚°
          const scale = newTouchDistance / lastTouchDistance;
          
          // ì¤Œ ì†ë„ ê³„ì‚°
          zoomVelocity = (scale - 1) * ZOOM_SPEED * 60;
          
          // í˜„ì¬ ì¤Œ ë ˆë²¨ ì—…ë°ì´íŠ¸
          currentZoom += zoomVelocity;
          currentZoom = Math.max(map.getMinZoom(), Math.min(map.getMaxZoom(), currentZoom));
          
          // ì§€ë„ ì¤Œ ë ˆë²¨ ì„¤ì •
          map.setZoom(currentZoom);
          
          // í˜„ì¬ ê±°ë¦¬ ì €ì¥
          lastTouchDistance = newTouchDistance;
        }
      });

      map.on('touchend', () => {
        lastTouchDistance = null;
        currentZoom = null;
        zoomVelocity = 0;
      });
    }

    // ì¤Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
    let zoomTimeout;
    map.on('zoom', () => {
      clearTimeout(zoomTimeout);
      zoomTimeout = setTimeout(updateZoomDisplay, 100);
    });

    // ì´ˆê¸° ì¤Œ ë ˆë²¨ ê°•ì œ ì„¤ì •
    map.once('load', () => {
      // ì•½ê°„ì˜ ì§€ì—°ì„ ì£¼ì–´ ì •í™•í•œ ì¤Œ ë ˆë²¨ ì„¤ì •
      setTimeout(() => {
        map.jumpTo({ zoom: 0 });
        updateZoomDisplay();
        updateLocationDisplay();
      }, 100);
    });

    // ìŠ¤íƒ€ì¼ ê°•ì œ ë¦¬ë¡œë“œ
    map.once('load', () => {
      map.setStyle('mapbox://styles/minhyeongkim/cmb0bsdjd00mq01rf97v47t59');
    });

    // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ pitch ì¡°ì • í•¨ìˆ˜
    function updateMapPitch() {
      const currentZoom = map.getZoom();
      let targetPitch = 0;
      if (currentZoom >= 12 && currentZoom <= 16) {
        // 12~16 ì¤Œ ë ˆë²¨ ì‚¬ì´ì—ì„œ 0~50ë„ë¡œ ì„ í˜• ë³´ê°„
        const zoomProgress = (currentZoom - 12) / (16 - 12);
        targetPitch = Math.min(60, Math.max(0, zoomProgress * 60));
      } else if (currentZoom < 12) {
        targetPitch = 0;
      } else {
        targetPitch = 60;
      }

      map.setPitch(targetPitch);
    }

    // ì§€ë„ê°€ ë¡œë“œë˜ë©´ ì •í™•í•œ ì¤Œ ë ˆë²¨ ì„¤ì •
    map.on('load', () => {
      updateZoomDisplay();
      updateMapPitch(); // ì´ˆê¸° pitch ì„¤ì •
      updateLocationDisplay(); // ì´ˆê¸° ìœ„ì¹˜ ì •ë³´ í‘œì‹œ
      
      // ëª¨ë“  ì§€ë„ ìƒíƒœ ë³€í™”ì— ëŒ€í•´ ì¤Œ ë ˆë²¨ í‘œì‹œ ì—…ë°ì´íŠ¸
      const events = ['zoom', 'zoomend', 'move', 'moveend', 'render', 'idle', 'style.load', 'data', 'sourcedata', 'styledata'];
      events.forEach(eventType => {
        map.on(eventType, updateZoomDisplay);
      });

      // ì§€ë„ ì´ë™ì´ ëë‚  ë•Œë§ˆë‹¤ ìœ„ì¹˜ ì •ë³´ ì—…ë°ì´íŠ¸
      map.on('moveend', debouncedUpdateLocation);

      // ì¤Œ ë³€ê²½ ì‹œ ì¦‰ì‹œ pitch ì—…ë°ì´íŠ¸
      map.on('zoom', updateMapPitch);

      // ì£¼ê¸°ì ìœ¼ë¡œ zoomDisplay ì—…ë°ì´íŠ¸ (ë°±ì—… ë©”ì»¤ë‹ˆì¦˜)
      setInterval(updateZoomDisplay, 1000);
    });

    // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
    map.on('click', (e) => {
      const zoom = map.getZoom();
      if (zoom >= 11) {
        // ë§ˆì»¤ë‚˜ íŒì—…ì„ í´ë¦­í•œ ê²½ìš°ê°€ ì•„ë‹ˆë¼ë©´ ëª¨ë“  íŒì—… í‘œì‹œ
        if (!e.originalEvent.defaultPrevented) {
          markerPopupPairs.forEach(({ marker, popup, location }) => {
            if (zoom >= 13) {
              popup.setLngLat(location).addTo(map);
            }
          });
        }
      }
    });

    // í´ëŸ¬ìŠ¤í„° ìƒì„± í•¨ìˆ˜
    function createCluster(locations, zoom) {
      const clusters = new Map();
      
      // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ê·¸ë¦¬ë“œ í¬ê¸° ì¡°ì •
      let gridSize;
      if (zoom < 7) {
        gridSize = 0.5; // ì•½ 55km
      } else if (zoom < 8) {
        gridSize = 0.3; // ì•½ 33km
      } else if (zoom < 9) {
        gridSize = 0.2; // ì•½ 22km
      } else if (zoom < 10) {
        gridSize = 0.1; // ì•½ 11km
      } else {
        gridSize = 0.05; // ì•½ 5.5km
      }
      
      locations.forEach(loc => {
        // ìœ„ë„, ê²½ë„ë¥¼ ê·¸ë¦¬ë“œ ì¢Œí‘œë¡œ ë³€í™˜ (gridSize ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼)
        const gridLat = Math.round(loc.lat / gridSize) * gridSize;
        const gridLng = Math.round(loc.lng / gridSize) * gridSize;
        const key = `${gridLat},${gridLng}`;
        
        if (!clusters.has(key)) {
          clusters.set(key, {
            center: [loc.lng, loc.lat],
            count: 1,
            points: [loc]
          });
        } else {
          const cluster = clusters.get(key);
          cluster.count++;
          cluster.points.push(loc);
          // ì¤‘ì‹¬ì ì„ ëª¨ë“  í¬ì¸íŠ¸ì˜ í‰ê· ìœ¼ë¡œ ì—…ë°ì´íŠ¸
          cluster.center = [
            cluster.points.reduce((sum, p) => sum + p.lng, 0) / cluster.points.length,
            cluster.points.reduce((sum, p) => sum + p.lat, 0) / cluster.points.length
          ];
        }
      });
      
      return clusters;
    }

    // í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìƒì„± í•¨ìˆ˜
    function createClusterMarker(center, count) {
      const el = document.createElement('div');
      const size = Math.min(40 + count * 5, 80); // ìµœì†Œ 40px, ìµœëŒ€ 80px
      
      el.style.width = `${size}px`;
      el.style.height = `${size}px`;
      el.style.borderRadius = '50%';
      el.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      el.style.display = 'flex';
      el.style.alignItems = 'center';
      el.style.justifyContent = 'center';
      el.style.color = 'white';
      el.style.fontSize = '20px';
      el.style.fontWeight = 'bold';
      el.textContent = count;
      
      return new mapboxgl.Marker({
        element: el,
        clickTolerance: 0
      }).setLngLat(center);
    }

    // í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ë“¤ì„ ì €ì¥í•  ë°°ì—´
    let clusterMarkers = [];

    // ë§ˆì»¤ì™€ íŒì—…ì„ í•¨ê»˜ ì €ì¥í•  ë°°ì—´
    const markerPopupPairs = [];
    const markerLabelPairs = [];

    // fetch()ëŠ” .then() ì²´ì¸ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨
    fetch('users_updated_with_scattered.json')
      .then(res => res.json())
      .then(users => { // ì´ ì•ˆì—ì„œë§Œ users ì‚¬ìš© ê°€ëŠ¥ ğŸ‘‡
        users.forEach(user => {
          const avatar = document.createElement('div');
          avatar.style.width = '50px';
          avatar.style.height = '50px';
          avatar.style.borderRadius = '50%';
          avatar.style.overflow = 'hidden';
          avatar.style.boxShadow = '0 0 6px rgba(0,0,0,0.3)';
          avatar.style.cursor = 'pointer';
          avatar.style.display = 'none'; // ì´ˆê¸°ì— ìˆ¨ê¹€ ìƒíƒœë¡œ ì„¤ì •

          const img = document.createElement('img');
          img.src = `images/${user.characterImg}`;
          img.alt = user.nickname;
          img.style.width = '100%';
          img.style.height = '100%';
          img.style.objectFit = 'cover';
          avatar.appendChild(img);

          // íŒì—… ìƒì„± (offset: ë§ˆì»¤ì™€ì˜ ê±°ë¦¬)
          const popup = new mapboxgl.Popup({ offset: 29, closeButton: false }).setDOMContent((() => {
            const popupContent = document.createElement('div');
            popupContent.className = 'popup-content';
            popupContent.innerHTML = `
              <div class="popup-content">
                <div class="song-info">${user.title}</div>
                <div class="artist">${user.artist}</div>
              </div>`;
            return popupContent;
          })());

          // ë§ˆì»¤ ê°ì²´ ìƒì„±
          const marker = new mapboxgl.Marker({
            element: avatar,
            clickTolerance: 0
          })
          .setLngLat(user.location)
          .setPopup(popup)
          .addTo(map);

          // ë‹‰ë„¤ì„ ë¼ë²¨ DOM ìƒì„±
          const label = document.createElement('div');
          label.textContent = user.nickname;
          label.style.position = 'absolute';
          label.style.transform = 'translate(-50%, 0)';
          label.style.fontSize = '11px';
          label.style.fontWeight = 'bold';
          label.style.color = '#333';
          label.style.background = 'rgba(255, 255, 255, 0.8)';
          label.style.padding = '2px 4px';
          label.style.borderRadius = '12px';
          label.style.boxShadow = '0 1px 2px rgba(0,0,0,0.15)';
          label.style.display = 'none';
          label.style.zIndex = '1';
          document.body.appendChild(label);

          markerPopupPairs.push({ marker, popup, label, avatar, img, location: user.location });
          markerLabelPairs.push({ label, location: user.location });
        });

        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ë§ˆì»¤ í‘œì‹œ ì—…ë°ì´íŠ¸
        map.on('zoomend', () => {
          const zoom = map.getZoom();

          // í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ì´ˆê¸°í™”
          clusterMarkers.forEach(marker => marker.remove());
          clusterMarkers = [];

          // ëª¨ë“  ë§ˆì»¤ì™€ íŒì—… ì œê±°
          markerPopupPairs.forEach(({ marker, popup, label }) => {
            marker.remove();
            popup.remove();
            label.style.display = 'none';
          });

          // ì¤Œ ë ˆë²¨ 11 ë¯¸ë§Œì—ì„œëŠ” í´ëŸ¬ìŠ¤í„°ë§Œ í‘œì‹œ
          if (zoom < 11) {
            const locations = markerPopupPairs.map(({ location }) => ({
              lat: location[1],
              lng: location[0]
            }));
            
            const clusterData = createCluster(locations, zoom);
            
            clusterData.forEach((data, key) => {
              const clusterMarker = createClusterMarker(data.center, data.count);
              clusterMarker.addTo(map);
              clusterMarkers.push(clusterMarker);
            });
          } else {
            markerPopupPairs.forEach(({ marker, popup, label, avatar, img, location }) => {
              // ì¤Œ ë ˆë²¨ 13 ì´ìƒì¸ ê²½ìš°
              if (zoom >= 13) {
                // ë§ˆì»¤ ì‚¬ì´ì¦ˆ ë³€ê²½ 
                avatar.style.width = '40px';
                avatar.style.height = '40px';
                avatar.style.display = 'block';
                img.style.display = 'block';
                // ë§ˆì»¤ ì¶”ê°€
                marker.addTo(map);
                // ë‹‰ë„¤ì„ í‘œì‹œ
                label.style.display = 'block'; 
                // íŒì—… í‘œì‹œ
                if (!popup.isOpen()) {
                  popup.setLngLat(location).addTo(map);
                }
              // ì¤Œ ë ˆë²¨ 11 ~ 13 ì‚¬ì´
              } else {
                // ë§ˆì»¤ ì‚¬ì´ì¦ˆ ë³€ê²½ 
                avatar.style.width = '32px';
                avatar.style.height = '32px';
                avatar.style.display = 'block';
                img.style.display = 'block';
                // ë§ˆì»¤ ì¶”ê°€
                marker.addTo(map);
                // ë‹‰ë„¤ì„ í‘œì‹œ
                label.style.display = 'block';
                // íŒì—… ìˆ¨ê¹€
                popup.remove();
              }

              // ë§ˆì»¤ í¬ê¸°ì— ë”°ë¥¸ ë¼ë²¨ ìœ„ì¹˜ ì¡°ì •
              const markerSize = parseInt(avatar.style.width);
              const labelOffset = markerSize / 2 + 8;

              const pos = map.project(location);
              label.style.left = `${pos.x}px`;
              label.style.top = `${pos.y + labelOffset}px`;
            });
          }
        });

        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        map.fire('zoomend');

        // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬
        markerPopupPairs.forEach(({ marker, popup, location }) => {
          marker.getElement().addEventListener('click', (e) => {
            e.preventDefault(); // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
            const zoom = map.getZoom();
            if (zoom >= 11) {
              // ë‹¤ë¥¸ íŒì—…ë“¤ ëª¨ë‘ ì œê±°
              markerPopupPairs.forEach(pair => pair.popup.remove());
              // í´ë¦­í•œ ë§ˆì»¤ì˜ íŒì—…ë§Œ í‘œì‹œ
              popup.setLngLat(location).addTo(map);
            }
          });
        });
      })
      .catch(err => {
        console.error('âŒ ìœ ì € ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', err);
      });

    // í˜„ì¬ ìœ„ì¹˜ ì¶”ì  ë³€ìˆ˜
    let locationMarker = null;
    let locationPopup = null;
    let watchId = null;

    // í˜„ì¬ ìœ„ì¹˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('currentLocation').addEventListener('click', () => {
      const button = document.getElementById('currentLocation');
      
      // ìœ„ì¹˜ ì •ë³´ ìš”ì²­
      if ('geolocation' in navigator) {
        button.classList.add('active');

        // ìœ„ì¹˜ ì •ë³´ ê°ì‹œ ì‹œì‘ (ì´ë¯¸ watchIdê°€ ìˆë‹¤ë©´ ìƒˆë¡œ ì‹œì‘í•˜ì§€ ì•ŠìŒ)
        if (!watchId) {
          watchId = navigator.geolocation.watchPosition(
            (position) => {
              const { latitude, longitude } = position.coords;

              // ìœ„ì¹˜ ë§ˆì»¤ì™€ íŒì—…ì´ ì—†ìœ¼ë©´ ìƒì„±
              if (!locationMarker) {
                const el = document.createElement('div');
                el.style.width = '16px';
                el.style.height = '16px';
                el.style.borderRadius = '50%';
                el.style.backgroundColor = '#3B82F6';
                el.style.border = '3px solid white';
                el.style.boxShadow = '0 0 0 2px #3B82F6';

                // íŒì—… ìƒì„±
                locationPopup = new mapboxgl.Popup({
                  closeButton: false,
                  closeOnClick: false,
                  offset: [0, -10]
                })
                .setHTML('<div style="text-align: center; font-weight: 600;">í˜„ì¬ ìœ„ì¹˜</div>');

                locationMarker = new mapboxgl.Marker(el)
                  .setLngLat([longitude, latitude])
                  .setPopup(locationPopup)
                  .addTo(map);

                // ë§ˆì»¤ì— ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì¶”ê°€
                el.addEventListener('mouseenter', () => locationPopup.addTo(map));
                el.addEventListener('mouseleave', () => locationPopup.remove());
              }

              // ë§ˆì»¤ì™€ íŒì—… ìœ„ì¹˜ ì—…ë°ì´íŠ¸
              locationMarker.setLngLat([longitude, latitude]);
              if (locationPopup.isOpen()) {
                locationPopup.setLngLat([longitude, latitude]);
              }

              // ë²„íŠ¼ì´ active ìƒíƒœì¼ ë•Œë§Œ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
              if (button.classList.contains('active')) {
                // í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™í•˜ê³  ì¤Œ ë ˆë²¨ ì„¤ì •
                map.jumpTo({
                  center: [longitude, latitude],
                  zoom: 16
                });
                // ì´ë™ í›„ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                button.classList.remove('active');
              }
            },
            (error) => {
              console.error('ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error);
              button.classList.remove('active');
              if (locationMarker) {
                locationMarker.remove();
                locationMarker = null;
              }
              if (locationPopup) {
                locationPopup.remove();
                locationPopup = null;
              }
              if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
              }
            },
            {
              enableHighAccuracy: true,
              timeout: 5000,
              maximumAge: 0
            }
          );
        } else {
          // watchIdê°€ ì´ë¯¸ ìˆëŠ” ê²½ìš°, í˜„ì¬ ìœ„ì¹˜ë¡œ ë°”ë¡œ ì´ë™
          if (locationMarker) {
            const currentPos = locationMarker.getLngLat();
            map.jumpTo({
              center: [currentPos.lng, currentPos.lat],
              zoom: 16
            });
          }
          // ì´ë™ í›„ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
          button.classList.remove('active');
        }
      } else {
        console.error('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        button.classList.remove('active');
      }
    });

    // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ìœ„ì¹˜ ì¶”ì  ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
    });
  </script>
</body>
</html>
